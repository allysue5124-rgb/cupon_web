<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>兌換券</title>
  <style>
    :root{
      --bg: #775b5f;
      --card: hsl(223, 100%, 97%);
      --text: #47040f;
      --muted: #1c222e;
      --border: #ce9a9a;
      --shadow: 0 10px 30px rgba(100, 36, 50, 0.534);
      --shadow2: 0 6px 18px rgba(75, 23, 38, 0.384);
      --accent: #6e2843b7;
      --accent2:#e05959ea;
      --danger:#6d1c16;
      --ok:#10504b;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 15% 0%, #eef2f6 0%, var(--bg) 45%, #f3f4f6 100%);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans TC", Arial, sans-serif;
      line-height:1.45;
    }
    .wrap{ max-width: 1100px; margin: 28px auto; padding: 0 16px; }
    .header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:14px;
      margin-bottom: 14px;
    }
    h1{ font-size: 50px; margin:0; letter-spacing: .2px; }
    .sub{ color:var(--muted); font-size: 13px; margin-top:6px; }

    .panel{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .row + .row{ margin-top:10px; }

    .input{
      flex: 1 1 360px;
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border:1px solid var(--border);
      border-radius: 12px;
      background: #fbfbfc;
    }
    .input input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font-size:14px;
      color:var(--text);
    }
    .btn{
      border:1px solid var(--border);
      background: #ffffff;
      color: var(--accent);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease;
      user-select:none;
    }
    .btn:hover{ box-shadow: var(--shadow2); background:#fbfbfc; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{
      background: var(--accent);
      border-color: var(--accent);
      color:#fff;
    }
    .btn.primary:hover{ background: #2b3a4d; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background:#fbfbfc;
      color: var(--muted);
      font-size: 12px;
      white-space:nowrap;
    }
    .dot{ width:8px; height:8px; border-radius: 999px; background: #cbd5e1; }
    .dot.ok{ background: #5eead4; }
    .dot.bad{ background: #fca5a5; }

    .hint{ color:var(--muted); font-size: 12px; }
    .danger{ color: var(--danger); font-weight: 800; }
    .ok{ color: var(--ok); font-weight: 800; }
    code.inline{ background:#eef2f7; padding:2px 6px; border-radius: 8px; border:1px solid #e6eaf0; }

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
    }
    .card{
      position:relative;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
      transition: transform .15s ease, box-shadow .2s ease;
      min-height: 128px;
    }
    .card:hover{ transform: translateY(-2px); box-shadow: var(--shadow2); }
    .title{ font-weight: 1000; letter-spacing: .2px; }
    .meta{ margin-top: 8px; color: var(--muted); font-size: 13px; }
    .remain{
      margin-top: 10px;
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      font-size: 13px;
    }
    .badge{
      display:inline-flex; align-items:center;
      padding: 4px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background:#fbfbfc;
      color: var(--accent2);
      font-weight: 850;
      min-width: 42px;
      justify-content:center;
    }
    .badge.zero{ color: #9ca3af; }

    .hoverBox{
      position:absolute;
      left:12px; right:12px; bottom:12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(251,251,252,0.98);
      box-shadow: var(--shadow2);
      padding: 12px;
      transform: translateY(8px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .15s ease, transform .15s ease;
    }
    .card:hover .hoverBox{
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .desc{ color: var(--text); font-size: 13px; }
    .small{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .actions{ margin-top: 10px; display:flex; gap:10px; }

    .redeemBtn{
      border:1px solid var(--accent);
      background: transparent;
      color: var(--accent);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 850;
      font-size: 13px;
    }
    .redeemBtn:hover{ background:#f3f4f6; }
    .redeemBtn:disabled{
      border-color: var(--border);
      color: #9ca3af;
      cursor:not-allowed;
      background: #f9fafb;
    }

    .modalBg{
      display:none;
      position:fixed; inset:0;
      background: rgba(15,23,42,0.35);
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(520px, 96vw);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow2);
      padding: 16px;
    }
    .modal h2{ margin: 0 0 8px 0; font-size: 16px; }
    .modal p{ margin: 6px 0; color: var(--muted); font-size: 13px; }
    .modalBtns{ display:flex; justify-content:flex-end; gap:10px; margin-top: 14px; }

    .toast{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 60;
      background: rgba(17,24,39,0.92);
      color: #fff;
      padding: 12px 14px;
      border-radius: 14px;
      box-shadow: var(--shadow2);
      display:none;
      max-width: min(420px, calc(100vw - 32px));
      font-size: 13px;
      white-space: pre-wrap;
    }
    .footerNote{ margin-top: 14px; color: var(--muted); font-size: 12px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>兌換券</h1>
      </div>
      <div class="pill" id="statusPill"><span class="dot" id="statusDot"></span><span id="statusText">尚未載入</span></div>
    </div>

    <div class="panel">
      <div class="row">
        <div class="input" title="兌換（寫入 GitHub 檔案）需要 Token">
          <input id="token" type="password" placeholder="貼上 GitHub Token（只需一次，會存在此瀏覽器）" />
        </div>
        <button class="btn primary" id="saveToken">儲存 Token</button>
        <button class="btn" id="load">重新載入</button>
      </div>
      <div class="row">
        
      </div>
    </div>

    <div id="grid" class="grid"></div>

  
  </div>

  <!-- modal -->
  <div id="modalBg" class="modalBg" role="dialog" aria-modal="true" aria-label="確認兌換">
    <div class="modal">
      <h2>確認兌換</h2>
      <div id="modalBody"></div>
      <div class="modalBtns">
        <button class="btn" id="cancelBtn">取消</button>
        <button class="btn primary" id="okBtn">確定兌換</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/** ====== 你的 repo 設定（已依你專案填好） ====== */
const OWNER  = "allysue5124-rgb";
const REPO   = "cupon_web";
const BRANCH = "main";
const PATH   = "coupons.json";

/** ====== Discord Webhook（你已提供） ====== */
const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1469263538064199792/qlJoiqx0tnDDlLESdhAAUG_cbW_8dw2h81zSM_FqA-36q0nT_XCCBbdPVtERjwDc6GOt";

/** ====== DOM ====== */
const grid = document.getElementById("grid");
const tokenInput = document.getElementById("token");
const toast = document.getElementById("toast");
const modalBg = document.getElementById("modalBg");
const modalBody = document.getElementById("modalBody");
const statusText = document.getElementById("statusText");
const statusDot = document.getElementById("statusDot");

/** ====== State ====== */
let couponsData = null;
let fileSha = null;
let pendingCouponIndex = null;

function setStatus(text, kind="idle"){
  statusText.textContent = text;
  statusDot.className = "dot";
  if (kind === "ok") statusDot.classList.add("ok");
  if (kind === "bad") statusDot.classList.add("bad");
}

function showToast(msg){
  toast.textContent = msg;
  toast.style.display = "block";
  setTimeout(() => toast.style.display = "none", 3200);
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

function getToken(){
  return localStorage.getItem("gh_token") || "";
}

document.getElementById("saveToken").onclick = () => {
  const t = tokenInput.value.trim();
  if (!t) return showToast("請貼上 GitHub Token");
  localStorage.setItem("gh_token", t);
  tokenInput.value = "";
  showToast("Token 已儲存（只在這台瀏覽器）");
};

document.getElementById("load").onclick = () => loadCoupons();

async function githubFetch(url, {method="GET", token="", body=null} = {}){
  const headers = { "Accept": "application/vnd.github+json" };
  if (token) headers["Authorization"] = `Bearer ${token}`;
  if (body) headers["Content-Type"] = "application/json";

  return fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : null
  });
}

/** ✅ 讀取策略：先讀同站 ./coupons.json（最穩，中文不亂碼）；失敗才用 Contents API */
async function loadCoupons(){
  setStatus("載入中…");
  grid.innerHTML = "載入中…";

  // 1) 先用 GitHub Pages 同站 JSON
  try{
    const r = await fetch(`./${PATH}?v=${Date.now()}`, { cache: "no-store" });
    if (r.ok){
      couponsData = await r.json();
      // 這種讀法拿不到 sha（寫入前再抓）
      setStatus("已載入", "ok");
      renderCoupons();
      return;
    }
  }catch{}

  // 2) fallback：用 GitHub Contents API（private 才需要）
  const token = getToken();
  if (!token){
    setStatus("讀取失敗（需要 Token）", "bad");
    grid.innerHTML = `
      <div class="panel">
        <div class="danger">讀取失敗：需要 GitHub Token</div>
        <div class="hint" style="margin-top:8px;">
          若 repo 是 Private，讀取 <code class="inline">coupons.json</code> 需要 Token。<br/>
          請貼上 Token → 儲存 → 再按「重新載入」。
        </div>
      </div>`;
    return;
  }

  const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;
  const res = await githubFetch(url, { token });

  if (!res.ok){
    const txt = await res.text().catch(() => "");
    setStatus(`讀取失敗 ${res.status}`, "bad");
    grid.innerHTML = `
      <div class="panel">
        <div class="danger">讀取 coupons.json 失敗：${res.status}</div>
        <div class="hint" style="margin-top:8px;">
          可能原因：Token 權限不足、repo/branch/path 錯誤。<br/>
          <span class="small">（訊息：${escapeHtml(txt.slice(0, 220))}）</span>
        </div>
      </div>`;
    return;
  }

  const j = await res.json();
  fileSha = j.sha;

  // ✅ 正確 utf-8 解碼 base64
  const b64 = (j.content || "").replace(/\n/g, "");
  const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
  const decoded = new TextDecoder("utf-8").decode(bytes);
  couponsData = JSON.parse(decoded);

  setStatus("已載入", "ok");
  renderCoupons();
}

function renderCoupons(){
  // 支援兩種格式：{coupons:[...]} 或直接 [...]
  const list = Array.isArray(couponsData) ? couponsData : (couponsData?.coupons || []);

  if (!Array.isArray(list) || list.length === 0){
    grid.innerHTML = `
      <div class="panel">
        <div class="danger">券資料格式不正確或是空的</div>
        <div class="hint" style="margin-top:8px;">建議格式：{ "coupons": [ ... ], "updated_at": "..." }</div>
      </div>`;
    return;
  }

  // 如果 couponsData 是 array，包回物件，方便寫回更新
  if (Array.isArray(couponsData)){
    couponsData = { coupons: list, updated_at: new Date().toISOString() };
  } else if (!couponsData.updated_at){
    couponsData.updated_at = new Date().toISOString();
  }

  grid.innerHTML = "";
  couponsData.coupons.forEach((c, idx) => {
    const card = document.createElement("div");
    card.className = "card";

    const remain = Number(c.remain ?? 0);
    const disabled = remain <= 0;

    card.innerHTML = `
      <div class="title">${escapeHtml(c.title ?? `兌換券 ${idx+1}`)}</div>
      <div class="remain">
        <span>剩餘兌換次數</span>
        <span class="badge ${disabled ? "zero" : ""}">${remain}</span>
      </div>

      <div class="hoverBox">
        <br>
        <div class="desc">${escapeHtml(c.desc ?? "")}</div>
        <div class="actions">
          <button class="redeemBtn" ${disabled ? "disabled" : ""} data-idx="${idx}">
            ${disabled ? "已用完" : "兌換"}
          </button>
        </div>
      </div>
    `;

    const btn = card.querySelector(".redeemBtn");
    if (btn && !disabled){
      btn.addEventListener("click", () => openConfirm(idx));
    }
    grid.appendChild(card);
  });
}

function openConfirm(idx){
  const c = couponsData.coupons[idx];
  pendingCouponIndex = idx;

  modalBody.innerHTML = `
    <p><b>${escapeHtml(c.title)}</b></p>
    <p>確定要兌換 <b>1 次</b> 嗎？</p>
    <p>目前剩餘：<b>${escapeHtml(String(c.remain))}</b></p>
    <p class="hint">確定後會扣除次數，並通知貓貓。</p>
  `;
  modalBg.style.display = "flex";
}

document.getElementById("cancelBtn").onclick = () => {
  modalBg.style.display = "none";
  pendingCouponIndex = null;
};

document.getElementById("okBtn").onclick = async () => {
  modalBg.style.display = "none";
  const idx = pendingCouponIndex;
  pendingCouponIndex = null;
  if (idx === null) return;

  const token = getToken();
  if (!token){
    showToast("兌換需要 GitHub Token");
    return;
  }

  const c = couponsData.coupons[idx];
  if ((c.remain ?? 0) <= 0){
    showToast("已經沒次數了");
    return;
  }

  // 先本地扣一次（體驗好）
  c.remain = Number(c.remain) - 1;
  couponsData.updated_at = new Date().toISOString();
  renderCoupons();

  try{
    await saveToGitHub(token, c);
    showToast("兌換成功：已更新並通知");
  }catch(e){
    // 失敗回滾
    c.remain = Number(c.remain) + 1;
    renderCoupons();
    console.error(e);
    showToast("更新失敗：請檢查 Token 是否正確");
  }
};

async function ensureSha(token){
  if (fileSha) return;
  const metaUrl = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}?ref=${BRANCH}`;
  const metaRes = await githubFetch(metaUrl, { token });
  if (!metaRes.ok) throw new Error("Failed to fetch sha before PUT");
  const meta = await metaRes.json();
  fileSha = meta.sha;
}

async function saveToGitHub(token, couponJustUsed){
  await ensureSha(token);

  const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
  const contentStr = JSON.stringify(couponsData, null, 2);

  const body = {
    message: `redeem ${couponJustUsed.id} (remain=${couponJustUsed.remain})`,
    content: btoa(unescape(encodeURIComponent(contentStr))),
    sha: fileSha,
    branch: BRANCH
  };

  const res = await githubFetch(api, { method: "PUT", token, body });

  if (!res.ok){
    const txt = await res.text().catch(() => "");
    throw new Error(`GitHub PUT failed: ${res.status} ${txt}`);
  }

  const out = await res.json();
  fileSha = out.content.sha;

  if (DISCORD_WEBHOOK_URL){
    await notifyDiscord(couponJustUsed);
  }
}

async function notifyDiscord(c){
  // 通知失敗不影響兌換
  try{
    await fetch(DISCORD_WEBHOOK_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        content: `兌換通知：${c.title}（${c.id}）被兌換 1 次，剩餘 ${c.remain}。`
      })
    });
  }catch{}
}

/** init */
setStatus("尚未載入");
loadCoupons();
</script>
</body>
</html>
